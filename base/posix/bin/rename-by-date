#!/bin/bash

. _barrkel_utils

function do_rename # src dst
{
    local i
    local dest
    local ext
    
    src="$1"
    dest="$2"
    
    base="$dest"
    ext="${src##*.}"
    
    dest="$base.$ext"
    
    if [ -f "$dest" ]; then
        let i=1
        while true; do
            dest="$(printf '%s-%.3d.%s' "$base" "$i" "$ext")"
            test -f "$dest" || break
            let ++i
        done
    fi
    
    mv -i -- "$1" "$dest" || die "Couldn't move '$1' to '$dest'."
}

function usage
{
    echo "usage: $(basename $0) <file>..."
    echo "Renames files by date."
    exit 1
}

test -f "$1" || usage

while [ -n "$1" ]; do
    test -f "$1" || usage
    
    dir="$(dirname "$1")"
    
    do_rename "$1" "$dir"/"$(get-photo-date -t -q "$1")"
    
    shift
done
